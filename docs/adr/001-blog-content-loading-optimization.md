# ADR 001: Static Site Generation による記事読み込みの最適化

## ステータス

承認 - 2025-01-01

## コンテキスト

現在の tech-jugoya-ai ブログには以下の課題がある：

1. **パフォーマンスの問題**

   - 分割された JSON ファイルの逐次読み込みによる遅延
   - 実行時のファイル読み込みによる TTFB の悪化
   - 各ブロックファイルへの個別アクセスによるオーバーヘッド

2. **実装の複雑さ**
   - サーバーサイドでの読み込み最適化が必要
   - キャッシュ戦略の管理が複雑
   - エラーハンドリングの散在

## 決定事項

Next.js 15 の Static Site Generation（SSG）機能を活用し、全てのページをビルド時に静的生成する。

### 1. アプローチの変更

- **Before**: サーバーサイドでの最適化（並列読み込み、キャッシュ制御）
- **After**: ビルド時の静的生成（実行時の読み込み処理を排除）

### 2. 実装戦略

1. **ビルド時の処理**

   - 全記事データを一括で読み込み
   - 分割ファイルの統合
   - Zod による型安全な検証

2. **静的生成の範囲**

   - 記事ページ: 完全な静的生成
   - タグページ: 完全な静的生成
   - トップページ: 完全な静的生成

3. **最適化手法**
   - `generateStaticParams`によるパス生成
   - `dynamicParams = false`で未定義パスを制御
   - CDN によるエッジキャッシュ

## 技術的な実装

```typescript
// 1. ビルド時の記事読み込み
export async function loadAllPosts(): Promise<Array<Post & { slug: string }>> {
  // 全記事を一括で読み込み
  // 分割ファイルの統合
  // 型検証
}

// 2. 静的パスの生成
export async function generateStaticParams() {
  const posts = await loadAllPosts();
  return posts.map((post) => ({
    slug: post.slug,
  }));
}

// 3. 未定義パスの制御
export const dynamicParams = false;
```

## メリット

1. **パフォーマンス向上**

   - TTFB: CDN レイテンシのみ（〜50ms）
   - サーバー負荷: 最小限
   - First Contentful Paint: 大幅改善

2. **実装の簡素化**

   - サーバーサイドのロジック削減
   - キャッシュ戦略の単純化
   - エラーハンドリングの一元化

3. **運用の改善**
   - デプロイの安定性向上
   - モニタリングの簡素化
   - トラブルシューティングの容易化

## リスクと対策

1. **ビルド時間の増加**

   - リスク: 記事数増加に伴うビルド時間の長期化
   - 対策:
     - 差分ビルドの活用
     - ビルドキャッシュの最適化
     - 必要に応じたチャンク分割

2. **メモリ使用量**

   - リスク: ビルド時の全記事読み込みによるメモリ圧迫
   - 対策:
     - メモリ使用量の監視
     - ビルドプロセスの最適化
     - 必要に応じたバッチ処理

3. **緊急更新への対応**
   - リスク: 即時の内容更新が必要な場合の遅延
   - 対策:
     - Webhook 経由の自動再ビルド
     - 緊急時の手動再ビルドフロー

## 成功基準

1. **パフォーマンス指標**

   - TTFB: 50ms 以下（CDN 経由）
   - First Contentful Paint: 500ms 以下
   - Largest Contentful Paint: 1.5 秒以下

2. **ビルドパフォーマンス**

   - 記事 100 件までのビルド時間: 5 分以下
   - デプロイ完了まで: 10 分以下

3. **安定性指標**
   - ビルドの成功率: 99.9%以上
   - 本番環境でのエラー率: 0.01%以下

## モニタリング計画

1. **ビルド時の監視**

   - ビルド時間の推移
   - メモリ使用量
   - エラーログ

2. **本番環境の監視**
   - CDN キャッシュヒット率
   - エッジでのレスポンスタイム
   - エラーレート

## 実装スケジュール

1. **フェーズ 1: 基盤実装（2 日）**

   - 静的ローダーの実装
   - ビルド設定の調整
   - 基本的なテストの作成

2. **フェーズ 2: 移行（2 日）**

   - 既存ページの移行
   - エラーハンドリングの実装
   - E2E テストの作成

3. **フェーズ 3: 最適化（1 日）**
   - ビルドパフォーマンスの調整
   - モニタリングの設定
   - ドキュメントの更新

## 結論

Static Site Generation を全面的に採用することで、実装の複雑さを低減しつつ、パフォーマンスを大幅に改善できる。この方針により、運用負荷の軽減とユーザー体験の向上を同時に達成できる。

