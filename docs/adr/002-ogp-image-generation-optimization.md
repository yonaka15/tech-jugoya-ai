# ADR-002: OGP画像生成の最適化とキャッシュ戦略

## ステータス
- 提案: 2025-01-01
- 承認: 2025-01-01
- 実装: 2025-01-01

## 文脈

Next.js 15へのアップグレードに伴い、以下の課題に対応する必要がある：

1. OGP画像生成のパフォーマンス
   - 動的生成による遅延
   - 不必要な再生成
   - キャッシュの最適化

2. フォントの取り扱い
   - 日本語フォントの埋め込み
   - フォントファイルのサイズ最適化

3. API経由のデータ取得
   - 記事データの取得方法
   - キャッシュ制御

## 決定

以下の方針で実装を行う：

1. OGP画像生成の最適化
   - Edge Runtimeを使用
   - キャッシュ戦略の実装
   - エラーハンドリングの強化

2. 記事データのAPI化
   - `/api/posts/[slug]`エンドポイントの実装
   - キャッシュヘッダーの適切な設定
   - OGP生成時のキャッシュ制御

3. フォントの最適化
   - 可変フォント（Variable Font）の採用
   - Base64エンコードによる埋め込み
   - フォントサブセット化の検討

## 結果

1. キャッシュ戦略
   - 通常のアクセス: 1年間のキャッシュ
   - OGP生成時: キャッシュ無効化
   - Edge Cacheの活用

2. パフォーマンス
   - OGP画像生成時間の短縮
   - サーバー負荷の軽減
   - CDNキャッシュの有効活用

3. 保守性
   - APIエンドポイントの集中管理
   - フォント管理の一元化
   - エラーハンドリングの統一

## 検討事項

### 採用した案
1. Edge Runtime + APIアプローチ
   - 高速なOGP画像生成
   - 柔軟なキャッシュ制御
   - CDNとの親和性

2. 可変フォントの採用
   - ファイルサイズの最適化
   - 幅広いウェイトのサポート
   - 将来の拡張性

### 却下した案
1. 静的画像ファイルの使用
   - メリット: 高速な配信
   - デメリット: 柔軟性の欠如
   - 却下理由: 動的コンテンツへの対応が困難

2. CDNベースの画像生成サービス
   - メリット: 管理の容易さ
   - デメリット: コストと依存性
   - 却下理由: 自前での制御が必要

## 影響

### 技術的影響
1. ビルド時の考慮事項
   - フォントファイルの処理
   - APIエンドポイントの生成
   - キャッシュ設定の反映

2. デプロイメント
   - Edge Functionのデプロイ
   - キャッシュ制御の設定
   - フォントファイルの配布

### 運用への影響
1. モニタリング
   - OGP生成のパフォーマンス監視
   - APIエンドポイントの監視
   - エラー検知と通知

2. メンテナンス
   - フォントの更新手順
   - キャッシュの管理
   - エラーログの確認

## 備考

- Next.js 15の非同期params対応は別ADRで検討する
- フォントのサブセット化は将来の最適化として検討
- キャッシュ戦略は必要に応じて見直しを行う