# ADR-002: OGP画像生成の最適化とキャッシュ戦略

## ステータス
- 提案: 2025-01-01
- 承認: 2025-01-01
- 実装: 2025-01-01
- 更新: 2025-01-01 (Next.js 15対応の追加)

## 文脈

Next.js 15へのアップグレードに伴い、以下の課題に対応する必要がある：

1. OGP画像生成のパフォーマンス
   - 動的生成による遅延
   - 不必要な再生成
   - キャッシュの最適化

2. フォントの取り扱い
   - 日本語フォントの埋め込み
   - フォントファイルのサイズ最適化

3. API経由のデータ取得
   - 記事データの取得方法
   - キャッシュ制御

4. Next.js 15の非同期API対応
   - headersの非同期化
   - paramsの非同期化
   - 型の厳密化

## 決定

以下の方針で実装を行う：

1. OGP画像生成の最適化
   - Edge Runtimeを使用
   - キャッシュ戦略の実装
   - エラーハンドリングの強化

2. 記事データのAPI化
   - `/api/posts/[slug]`エンドポイントの実装
   - キャッシュヘッダーの適切な設定
   - OGP生成時のキャッシュ制御

3. フォントの最適化
   - 可変フォント（Variable Font）の採用
   - Base64エンコードによる埋め込み
   - フォントサブセット化の検討

4. Next.js 15対応
   - 非同期APIの適切な処理
   ```typescript
   const headersList = await headers();
   const host = headersList.get('host');
   ```
   - 型安全性の向上
   ```typescript
   export default async function Image({ 
     params 
   }: { 
     params: Promise<{ slug: string }> 
   })
   ```
   - メタデータ型の厳密化
   ```typescript
   const jsonLd = generateBlogPostJsonLd({
     ...post.meta,
     slug: resolvedParams.slug,
     author: post.meta.author || 'jugoya',
   });
   ```

## 結果

1. キャッシュ戦略
   - 通常のアクセス: 1年間のキャッシュ
   - OGP生成時: キャッシュ無効化
   - Edge Cacheの活用

2. パフォーマンス
   - OGP画像生成時間の短縮
   - サーバー負荷の軽減
   - CDNキャッシュの有効活用

3. 保守性
   - APIエンドポイントの集中管理
   - フォント管理の一元化
   - エラーハンドリングの統一

4. 型安全性
   - コンパイル時のエラー検出
   - ランタイムエラーの防止
   - メタデータの整合性確保

## 検討事項

### 採用した案
1. Edge Runtime + APIアプローチ
   - 高速なOGP画像生成
   - 柔軟なキャッシュ制御
   - CDNとの親和性

2. 可変フォントの採用
   - ファイルサイズの最適化
   - 幅広いウェイトのサポート
   - 将来の拡張性

3. 非同期処理の統一的なハンドリング
   - awaitの一貫した使用
   - エラー境界の明確化
   - 型の厳密化

### 却下した案
1. 静的画像ファイルの使用
   - メリット: 高速な配信
   - デメリット: 柔軟性の欠如
   - 却下理由: 動的コンテンツへの対応が困難

2. CDNベースの画像生成サービス
   - メリット: 管理の容易さ
   - デメリット: コストと依存性
   - 却下理由: 自前での制御が必要

3. 同期的なAPI呼び出し
   - メリット: コードの単純さ
   - デメリット: 将来的な非推奨化
   - 却下理由: Next.js 15の方針に反する

## 影響

### 技術的影響
1. ビルド時の考慮事項
   - フォントファイルの処理
   - APIエンドポイントの生成
   - キャッシュ設定の反映

2. デプロイメント
   - Edge Functionのデプロイ
   - キャッシュ制御の設定
   - フォントファイルの配布

3. 型システム
   - 新しいインターフェースの導入
   - ビルド時チェックの強化
   - 型定義の共有

### 運用への影響
1. モニタリング
   - OGP生成のパフォーマンス監視
   - APIエンドポイントの監視
   - エラー検知と通知

2. メンテナンス
   - フォントの更新手順
   - キャッシュの管理
   - エラーログの確認

3. 開発フロー
   - 型チェックの重要性増加
   - レビュー時の確認項目追加
   - テスト範囲の拡大

## 備考

- 非同期処理の統一的なアプローチを採用
- フォントのサブセット化は将来の最適化として検討
- キャッシュ戦略は必要に応じて見直しを行う
- 型システムの改善は継続的に実施